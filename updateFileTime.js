#!/usr/bin/env node
console.log("脚本开始运行..");var fs=require("fs"),file="./txt",RegExp=/(updated:\s*)((\d{2}(([02468][048])|([13579][26]))[\-\/\s]?((((0?[13578])|(1[02]))[\-\/\s]?((0?[1-9])|([1-2][0-9])|(3[01])))|(((0?[469])|(11))[\-\/\s]?((0?[1-9])|([1-2][0-9])|(30)))|(0?2[\-\/\s]?((0?[1-9])|([1-2][0-9])))))|(\d{2}(([02468][1235679])|([13579][01345789]))[\-\/\s]?((((0?[13578])|(1[02]))[\-\/\s]?((0?[1-9])|([1-2][0-9])|(3[01])))|(((0?[469])|(11))[\-\/\s]?((0?[1-9])|([1-2][0-9])|(30)))|(0?2[\-\/\s]?((0?[1-9])|(1[0-9])|(2[0-8]))))))(\s((([0-1][0-9])|(2?[0-3]))\:([0-5]?[0-9])((\s)|(\:([0-5]?[0-9])))))/g;function writeFileTime(e,t){t.readFile(e,"utf8",(function(n,o){if(n)return console.log("读取文件内容错误：",n);RegExp.test(o)&&t.stat(e,(function(n,s){if(n)return console.log("读取文件信息错误：",n);var r=o.match(RegExp);r.length>1&&console.log("文件"+e+"匹配到多处update字段");var i=r[0].replace("updated: ","").replace(/-/g,"/");if(new Date(s.mtime).getTime()-new Date(Date.parse(i))>3e5){var a=o.replace(RegExp,"updated: "+getFormatDate(s.mtime));t.writeFile(e,a,"utf8",(function(n){if(n)return console.log("写文件错误：",n);t.utimes(e,new Date(s.atime),new Date(s.mtime),(function(t){if(t)return console.log("修改时间失败：",t);console.log(e,"成功更新时间")}))}))}}))}))}function getFormatDate(e,t,n){t=t||"-",n=n||":";var o=new Date(e),s=o.getFullYear(),r=o.getMonth(),i=o.getDate(),a=o.getHours(),l=o.getMinutes(),g=o.getSeconds();return s+t+((r+1>9?r+1:"0"+(r+1))+t)+((i>9?i:"0"+i)+" ")+((a>9?a:"0"+a)+n)+((l>9?l:"0"+l)+n)+(g>9?g:"0"+g)}fs.readdir("./_posts/",(function(e,t){for(var n=t.length,o=null,s=0;s<n;s++)(o=t[s]).indexOf(".md")>-1&&(console.log("正在处理文件：",o),writeFileTime("_posts/"+o,fs))}));